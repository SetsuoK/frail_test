<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Assessment Demo</title>
    <link rel="icon" href="data:,">

    <!-- Tailwind (Play CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React UMD (production) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel (on-the-fly JSX transpile) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style> html,body{background:#f7fafc} </style>

    <!-- Pyodide本体 -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script>
      // Pyodide 初期化（結果画面で使用）
      window.pyodideReady = (async () => {
        const pyodide = await loadPyodide();
        await pyodide.loadPackage(["micropip","pandas"]);

        // PythonとCSVを仮想FSへ
        const fe = await fetch("./feedback_engine.py").then(r => r.text());
        pyodide.FS.writeFile("feedback_engine.py", fe);

        async function loadCsv(url, path){
          const txt = await fetch(url).then(r => r.text());
          pyodide.FS.writeFile(path, txt);
        }
        await loadCsv("./assets/feedback/templates_kcl_completed_v2.csv", "/templates_kcl_completed_v2.csv");
        await loadCsv("./assets/feedback/templates_khq_completed_v2.completed.csv", "/templates_khq_completed_v2.completed.csv");
        await loadCsv("./assets/feedback/safety_flags_complete.csv", "/safety_flags_complete.csv");

        // import 準備
        await pyodide.runPythonAsync(`
import sys
for p in (".","/"):
    if p not in sys.path:
        sys.path.append(p)
import feedback_engine
print("feedback_engine import OK")
        `);

        // JS から呼ぶラッパ
        await pyodide.runPythonAsync(`
from typing import Dict, List, Any
from feedback_engine import build_feedback
import inspect

def _to_py_set(x):
    try:
        return set(list(x))
    except Exception:
        return set()

def _to_py_dict(x):
    if x is None:
        return {}
    try:
        return dict(x)
    except Exception:
        try:
            return {k: x[k] for k in x.keys()}
        except Exception:
            return {}

def js_build_feedback(age_group: str, sex: str, kcl_on: list, khq_flags: dict, extras: dict=None) -> str:
    # JS -> Py に変換
    kcl_on_set = _to_py_set(kcl_on)
    kcl_items = {i: (1 if i in kcl_on_set else 0) for i in range(1, 26)}
    khq_dict = _to_py_dict(khq_flags)

    # build_feedback の受け取り可能な引数名を自動検出
    sig = inspect.signature(build_feedback)
    params = set(sig.parameters.keys())

    kcl_key_candidates = ['kcl_flags', 'kcl_items', 'kcl', 'flags_kcl']
    khq_key_candidates = ['khq_items', 'khq_flags', 'khq']

    kcl_key = next((n for n in kcl_key_candidates if n in params), None)
    khq_key = next((n for n in khq_key_candidates if n in params), None)

    kwargs = {
        'age_group': age_group,
        'sex': sex,
    }
    if kcl_key:
        kwargs[kcl_key] = kcl_items
    if khq_key:
        kwargs[khq_key] = {int(k): bool(v) for k, v in khq_dict.items()}

    # CSV パスは存在するキーにだけ渡す
    csv_args = {
        'csv_kcl_templates': "/templates_kcl_completed_v2.csv",
        'csv_khq_templates': "/templates_khq_completed_v2.completed.csv",
        'csv_safety_flags': "/safety_flags_complete.csv",
        'extras': extras or {}
    }
    for k, v in csv_args.items():
        if k in params:
            kwargs[k] = v

    text = build_feedback(**kwargs)
    return text
        `);

        return pyodide;
      })();
    </script>
  </head>

  <body>
    <div id="app"></div>

    <!-- あなたの JSX（ファイル名を合わせる） -->
    <script
      type="text/babel"
      data-presets="react,env"
      src="./app.jsx">
    </script>

    <!-- DOM 準備後に renderApp を呼ぶ -->
<script>
  (function waitAndRender(){
    if (typeof window.renderApp === 'function') {
      window.renderApp();
    } else {
      setTimeout(waitAndRender, 50);
    }
  })();
</script>

  </body>
</html>




